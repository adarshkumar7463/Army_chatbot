<!-- templates/main/home.html -->

{% extends 'main/base.html' %}
 {%load static %}
{% block content %}
<style>


                    /* === Trigger Button (kept in bottom-right) === */
        #chat-toggle {
        position: fixed;
        bottom: 16px;
        right: 24px;
        z-index: 1000;
        background: linear-gradient(135deg, var(--primary), #1a252f);
        color: #fff;
        border-radius: 50%;
        width: 60px; height: 60px;
        font-size: 22px;
        cursor: pointer;
        box-shadow: 0 10px 24px rgba(0,0,0,.25);
        display: grid; place-items: center;
        border: none;
        transition: transform .2s ease, box-shadow .2s ease;
        }

        #chat-toggle:hover { transform: translateY(-2px) scale(1.03); }

        /* === Centered Modal === */

        #chat-box {
        display: none;
        position: fixed;
        inset: 50% auto auto 50%;
        transform: translate(-50%,-50%) scale(.98);
        width: min(900px, 96vw);
        height: min(640px, 92vh);
        background: var(--chat-bg, #ffffff);
        color: var(--chat-text, #0b1220);
        border-radius: 16px;
        box-shadow: 0 30px 80px rgba(0,0,0,.45);
        z-index: 2000;
        overflow: hidden;
        opacity: 0;
        transition: opacity .2s ease, transform .2s ease;
        display: flex; flex-direction: column;
        border: 1px solid rgba(212,175,55,.25);
        }
        #chat-box.show { opacity: 1; transform: translate(-50%,-50%) scale(1); }

        /* Header */

        .chat-header {
        background: linear-gradient(135deg, var(--primary), #1a252f);
        color: #fff;
        padding: 12px 16px;
        display: flex; align-items: center; justify-content: space-between;
        }

        .chat-title-wrap { display: flex; align-items: center; gap: 10px; }
        .chat-title-wrap i { color: var(--accent); font-size: 20px; }
        .chat-header h3 { margin: 0; font-size: 1.05rem; letter-spacing: .3px; }
        
        .icon-btn {
        background: transparent; border: none; color: #fff; cursor: pointer;
        font-size: 1rem; padding: 6px 8px; border-radius: 8px;
        transition: background .2s ease, transform .1s ease;
        }
        .icon-btn:hover { background: rgba(255,255,255,.08); }
        .chat-tools { display: flex; align-items: center; gap: 6px; }

        /* Layout */
        .chat-body {
        flex: 1;
        display: grid;
        grid-template-columns: 230px 1fr;
        min-height: 0;  /* üîë allow grid children to shrink */
        }

        /* Sidebar */
        #chat-sidebar {
        background: var(--sidebar-bg, #f2f5f7);
        border-right: 1px solid rgba(0,0,0,.08);
        padding: 10px; overflow-y: auto;
        }
        .sidebar-header {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 6px;
        }
        .sidebar-header h4 { margin: 0; font-size: .9rem; color: var(--accent); }
        .tiny-btn {
        background: transparent; border: none; color: #777; cursor: pointer;
        font-size: .9rem; padding: 4px 6px; border-radius: 6px;
        }

        .tiny-btn:hover { background: rgba(0,0,0,.06); color: #444; }
        #recent-searches { 
          list-style: none; 
          margin: 0;
          padding: 0; 
          display: grid; 
          gap: 6px; 
          max-height: 400px;   /* adjust height as needed */
          overflow-y:auto;   /* vertical scroll when content exceeds max-height */
          list-style: none;
        }

        #recent-searches li {
        background: rgba(0,0,0,.03);
        border: 1px solid rgba(0,0,0,.06);
        padding: 8px 10px; border-radius: 8px;
        cursor: pointer; font-size: .9rem;
        transition: transform .12s ease, background .2s ease, box-shadow .2s ease;
        }

        #recent-searches li:hover {
        background: rgba(212,175,55,.12);
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(0,0,0,.06);
        }

            /* Messages */
        .chat-main {
            display: flex;
            flex-direction: column;
            min-height: 0;  /* üîë */
            }



        #chat-messages {
            flex: 1;
            min-height: 0;   /* üîë prevent overflow cutoff */
            overflow-y: auto;
            padding: 14px;
            background: var(--chat-pane-bg, #f9fbfc);
            display: flex;
            flex-direction: column;
            gap: 10px;
            }

        .message {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 12px;
        animation: chatIn .25s ease both;
        font-size: .95rem; line-height: 1.55;
        box-shadow: 0 6px 16px rgba(0,0,0,.06);
        }
        @keyframes chatIn {
        from { opacity: 0; transform: translateY(6px) scale(.99); }
        to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .user-message {
        align-self: end;
        background: #5980a4;
        color: #071018;
        border-bottom-right-radius: 4px;
        }
        .bot-message {
        align-self: start;
        background: #acbac7;
        color: #09131a;
        border-bottom-left-radius: 4px;
        }
        .message-content ul.bullet-list { margin: 6px 0 0 16px; }

        /* Times */
        .message-time {
        font-size: .7rem; opacity: .7; text-align: right; margin-top: 6px;
        }

        /* Input Area */
        .chat-input-area {
        display: grid; grid-template-columns: auto 1fr auto auto;
        gap: 8px; align-items: center;
        border-top: 1px solid rgba(0,0,0,.08);
        padding: 10px; background: var(--input-bg, #eaeff3);
        }
        #chat-input {
        border: none; outline: none; padding: 12px 14px;
        border-radius: 10px; font-size: .95rem;
        background: #fff; color: #111; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
        }
        .send-btn {
        background: var(--primary); border: none; color: #fff; cursor: pointer;
        padding: 10px 14px; border-radius: 10px; display: grid; place-items: center;
        transition: transform .1s ease, filter .15s ease;
        }
        .send-btn:hover { filter: brightness(1.05); transform: translateY(-1px); }

        /* Typing Indicator */
        .typing-indicator {
        display: inline-flex; gap: 5px; padding: 6px 10px; align-items: center;
        }
        .typing-indicator span {
        height: 8px; width: 8px; background: #9aa7b3;
        border-radius: 50%; display: inline-block; animation: typing 1s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: .2s; }
        .typing-indicator span:nth-child(3) { animation-delay: .4s; }
        @keyframes typing {
        0%,100% { transform: translateY(0); opacity: .6; }
        50% { transform: translateY(-4px); opacity: 1; }
        }

        /* Dark Mode */
        body.dark-mode {
        --chat-bg: #101822;
        --chat-text: #e9eff7;
        --chat-pane-bg: #0c141d;
        --sidebar-bg: #0e1620;
        --input-bg: #0e151d;
        }
        body.dark-mode #chat-messages .user-message { color: #eaf2f8; }
        body.dark-mode #recent-searches li { background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.06); }
        body.dark-mode #recent-searches li:hover { background: rgba(212,175,55,.18); }

        /* Responsive */
        @media (max-width: 880px) {
        .chat-body { grid-template-columns: 1fr; }
        #chat-sidebar { display: none; }
        }
        @media (max-width: 520px) {
        #chat-box { width: 96vw; height: 88vh; }
        .chat-header h3 { font-size: .95rem; }
        }
    }
</style>
    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1 class="hero-title">Army Management System</h1>
            <p class="hero-subtitle">
                A comprehensive platform for managing detailed records of army officers, 
                including personal information, education history, family details, and prestigious awards. 
                Streamline your personnel management with our secure and efficient system.
            </p>
            <a href="{% url 'create_officer' %}" class="cta-btn">Get Started</a>
        </div>
        <div class="hero-image">
            <div class="image-container">
                <img src="{% static "pic.jpg" %}" alt="Military Officers">
                <div class="image-overlay">
                    <div class="image-title">Strategic Command Center</div>
                    <div class="image-desc">Advanced management for military personnel records</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-officer"></i>
            </div>
            <div class="stat-number">{{ officer_count }}</div>
            <div class="stat-label">Active Officers</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-medal"></i>
            </div>
            <div class="stat-number">{{ award_count }}</div>
            <div class="stat-label">Awards Granted</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="stat-number">{{ education_count }}</div>
            <div class="stat-label">Education Records</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="stat-number">99.8%</div>
            <div class="stat-label">System Uptime</div>
        </div>

<!-- Chat Widget Trigger -->
<button id="chat-toggle" aria-label="Open Chat">
    <i class="fas fa-comments"></i>
</button>

<!-- Chatbox Modal -->
<div id="chat-box" role="dialog" aria-modal="true" aria-labelledby="chat-title">
  <div class="chat-header">
    <div class="chat-title-wrap">
      <i class="fas fa-shield-alt"></i>
      <h3 id="chat-title">Command Information Assistant</h3>
    </div>
    <div class="chat-tools">
      <button id="theme-toggle" class="icon-btn" title="Toggle Dark/Light" aria-label="Toggle theme">
        <i class="fas fa-adjust"></i>
      </button>
      <button id="chat-close" class="icon-btn" title="Close" aria-label="Close chat">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <div class="chat-body">
    <!-- Sidebar: Recent Searches -->
    <aside id="chat-sidebar">
      <div class="sidebar-header">
        <h4>Recent Searches</h4>
        <button id="clear-recent" class="tiny-btn" title="Clear recent">
          <i class="fas fa-trash"></i>
        </button>
      </div>
      <ul id="recent-searches"></ul>
    </aside>

    <!-- Main Chat Area -->
    <section class="chat-main">
      <div id="chat-messages">
        <div class="message bot-message">
          <div class="message-content">
            Jai Hind! üáÆüá≥<br>
            I‚Äôm your <b>Army Records Assistant</b>.<br><br>
            Try:
            <ul class="bullet-list">
              <li>‚ÄúShow officers in Haryana Regiment‚Äù</li>
              <li>‚ÄúFamily of officer 12345‚Äù</li>
              <li>‚ÄúAwards of army number 1001‚Äù</li>
              <li>‚ÄúExport officer 1001 as PDF‚Äù</li>
            </ul>
            <div class="message-time">Just now</div>
          </div>
        </div>
      </div>

      <!-- Input & Tools -->
      <div class="chat-input-area">
        <input type="file" id="chat-file" hidden>
        <button id="file-btn" class="icon-btn" title="Upload File" aria-label="Upload file">
          <i class="fas fa-upload"></i>
        </button>

        <input type="text" id="chat-input" placeholder="Type here‚Ä¶ or use mic" aria-label="Chat input">

        <button id="voice-btn" class="icon-btn" title="Voice Input" aria-label="Voice input">
          <i class="fas fa-microphone"></i>
        </button>

        <button id="chat-send" class="send-btn" aria-label="Send">
          <i class="fas fa-paper-plane"></i>
        </button>
    </div>
    </section>
</div>
</div>
</section>
<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Core nodes
  const chatToggle = document.getElementById('chat-toggle');
  const chatBox = document.getElementById('chat-box');
  const chatClose = document.getElementById('chat-close');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');
  const chatMessages = document.getElementById('chat-messages');
  const recentList = document.getElementById('recent-searches');
  const clearRecentBtn = document.getElementById('clear-recent');
  const fileBtn = document.getElementById('file-btn');
  const fileInput = document.getElementById('chat-file');
  const voiceBtn = document.getElementById('voice-btn');
  const themeToggle = document.getElementById('theme-toggle');

  // Local state
  let recentSearches = loadRecent();
  renderRecent();

  // Open / Close with animation
  chatToggle.onclick = () => {
    chatBox.style.display = 'flex';
    requestAnimationFrame(() => chatBox.classList.add('show'));
  };
  chatClose.onclick = () => {
    chatBox.classList.remove('show');
    setTimeout(() => chatBox.style.display = 'none', 180);
  };

  // Send message
  function sendMessage() {
    const msg = (chatInput.value || '').trim();
    if (!msg) return;

    addMessage(msg, 'user');
    pushRecent(msg);
    chatInput.value = '';

    const typing = addTyping();

    fetch('/chatbot/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: `message=${encodeURIComponent(msg)}`
    })
    .then(r => r.json())
    .then(data => {
      typing.remove();
      addMessage((data.response || 'No response').replace(/\n/g, '<br>'), 'bot');
    })
    .catch(() => {
      typing.remove();
      addMessage('‚ö†Ô∏è Sorry, I encountered an error. Please try again.', 'bot');
    });
  }

  chatSend.onclick = sendMessage;
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  // UI helpers
  function addMessage(html, who) {
    const el = document.createElement('div');
    el.className = `message ${who}-message`;
    el.innerHTML = `
      <div class="message-content">
        ${html}
        <div class="message-time">${timeNow()}</div>
      </div>`;
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function addTyping() {
    const el = document.createElement('div');
    el.className = 'typing-indicator';
    el.innerHTML = '<span></span><span></span><span></span>';
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return el;
  }

  function timeNow() {
    const d = new Date();
    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }

  // Recent searches (persisted via localStorage)
  function loadRecent() {
    try { return JSON.parse(localStorage.getItem('recent_searches') || '[]'); }
    catch { return []; }
  }
  function saveRecent() {
    localStorage.setItem('recent_searches', JSON.stringify(recentSearches.slice(-8)));
  }
  function pushRecent(q) {
    recentSearches.push(q);
    recentSearches = recentSearches.slice(-30);
    saveRecent();
    renderRecent();
  }
  function renderRecent() {
    if (!recentList) return;
    recentList.innerHTML = '';
    recentSearches.forEach(q => {
      const li = document.createElement('li');
      li.textContent = q;
      li.title = 'Click to re-run';
      li.onclick = () => { chatInput.value = q; sendMessage(); };

      recentList.appendChild(li);
    });
  }
  clearRecentBtn && (clearRecentBtn.onclick = () => {
    recentSearches = [];
    saveRecent();
    renderRecent();
  });

  // File upload (kept UI-level only; no backend change)
  fileBtn.onclick = () => fileInput.click();
  fileInput.onchange = () => {
    const f = fileInput.files[0];
    if (f) addMessage(`üìÇ File ready: <b>${f.name}</b> (${Math.round(f.size/1024)} KB)`, 'user');
  };

  // Voice assistant (graceful fallback)
  let recognition = null;
  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-IN';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.onresult = (e) => {
      const transcript = e.results[0][0].transcript || '';
      chatInput.value = transcript;
      sendMessage();
    };
  }
  voiceBtn.onclick = () => {
    if (!recognition) {
      addMessage('üé§ Voice input not supported in this browser.', 'bot');
      return;
    }
    recognition.start();
  };

  // Theme toggle (persist)
  const THEME_KEY = 'chat_theme';
  const savedTheme = localStorage.getItem(THEME_KEY);
  if (savedTheme === 'dark') document.body.classList.add('dark-mode');

  themeToggle.onclick = () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem(THEME_KEY, document.body.classList.contains('dark-mode') ? 'dark' : 'light');
  };

  // CSRF helper (unchanged)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

{% endblock %}   